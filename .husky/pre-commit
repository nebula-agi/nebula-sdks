#!/bin/sh
# Auto-bump SDK versions when code changes

# Check Python SDK
if git diff --cached --name-only | grep -q "^python/nebula/\|^python/tests/\|^python/pyproject.toml"; then
  echo "Python SDK changes detected, bumping version..."
  cd python || exit 1

  CURRENT_VERSION=$(python3 - << 'EOF'
import re
from pathlib import Path

text = Path("pyproject.toml").read_text()
in_project = False
for line in text.splitlines():
    if line.strip().startswith("["):
        in_project = line.strip() == "[project]"
    if in_project:
        match = re.match(r'\s*version\s*=\s*"([^"]+)"', line)
        if match:
            print(match.group(1))
            raise SystemExit(0)

raise SystemExit("Could not find [project].version in pyproject.toml")
EOF
  )

  # Parse and bump patch version
  IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
  NEW_VERSION="${major}.${minor}.$((patch + 1))"

  echo "Bumping Python SDK: $CURRENT_VERSION -> $NEW_VERSION"

  python3 - << 'EOF' "$NEW_VERSION"
import re
import sys
from pathlib import Path

new_version = sys.argv[1]
path = Path("pyproject.toml")
text = path.read_text()
lines = text.splitlines()
in_project = False
updated = False

for i, line in enumerate(lines):
    if line.strip().startswith("["):
        in_project = line.strip() == "[project]"
    if in_project:
        match = re.match(r'\s*version\s*=\s*"([^"]+)"', line)
        if match:
            lines[i] = re.sub(r'"[^"]+"', f'"{new_version}"', line, count=1)
            updated = True
            break

if not updated:
    raise SystemExit("Could not find [project].version in pyproject.toml")

path.write_text("\n".join(lines) + ("\n" if text.endswith("\n") else ""))
EOF

  git add pyproject.toml
  cd ..
fi

# Check JavaScript SDK
if git diff --cached --name-only | grep -q "^javascript/src/"; then
  echo "JavaScript SDK changes detected, bumping version..."
  cd javascript || exit 1

  CURRENT_VERSION=$(node -p "require('./package.json').version")

  # Parse and bump patch version
  IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
  NEW_VERSION="${major}.${minor}.$((patch + 1))"

  echo "Bumping JavaScript SDK: $CURRENT_VERSION -> $NEW_VERSION"

  # Update version
  npm version "$NEW_VERSION" --no-git-tag-version --allow-same-version

  git add package.json
  cd ..
fi
